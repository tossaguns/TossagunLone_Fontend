<!-- FIXME: ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏≥‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ -->
<template>
  <TemplatePartner>
    <template #header>
      <label>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ POS</label>
    </template>

    <template #content>
      <div class="p-4 max-w-[3000px] mx-auto">

        <label class="text-2xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</label>

        <div class="mt-6">
          <div>
            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
            <div v-if="!isEditing">
              <label class="text-lg font-bold">‡∏Ñ‡∏£‡∏µ‡πÄ‡∏≠‡∏ó‡πÄ‡πÄ‡∏ó‡πá‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å</label>
              <div class="border rounded-lg p-4 mt-4">
                <div>
                  <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡πÄ‡∏ó‡πá‡∏Å</label>
                  <input type="text"
                    class="border rounded-md w-full py-2 px-2 mt-1 border-stone-300 hover:border-amber-600"
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡πÄ‡∏ó‡πá‡∏Å...‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ï‡πâ‡∏ö‡∏£‡∏£‡πÑ‡∏î / ‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ö‡∏£‡∏£‡πÑ‡∏î‡∏´‡∏ô‡∏µ‡πÑ‡∏ü / ‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå ..."
                    v-model="tagName" />
                </div>
                <div>
                  <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                  <textarea type="text" rows="3"
                    class="border rounded-md w-full py-2 px-2 mt-1 border-stone-300 hover:border-amber-600"
                    placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." v-model="tagDescription" />
                </div>
                <div>
                  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡πÄ‡∏ó‡πá‡∏Å‡∏™‡∏µ</label>
                  <div class="p-8 flex flex-col justify-center items-center">
                    <label class="text-gray-700 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
                    <ColorPicker v-model="selectedColor" />
                    <p class="text-sm text-gray-500 mt-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {{ selectedColor }}</p>
                  </div>
                </div>

                <div class="mt-4 flex justify-center space-x-2">
                  <button
                    class="text-amber-400 font-bold rounded-lg px-4 py-2 hover:text-amber-500 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                    @click="addTag" :disabled="loading">
                    {{ loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡πÄ‡∏ó‡πá‡∏Å' }}
                  </button>
                </div>
              </div>
            </div>

            <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
            <div v-if="isEditing">
              <label class="text-lg font-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡πÄ‡∏ó‡πá‡∏Å</label>
              <div class="border rounded-lg p-4 mt-4 bg-stone-50 shadow-md">
                <div>
                  <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡πÄ‡∏ó‡πá‡∏Å</label>
                  <input type="text"
                    class="border rounded-md w-full py-2 px-2 mt-1 border-stone-300 hover:border-amber-600 bg-amber-100"
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡πÄ‡∏ó‡πá‡∏Å...‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ï‡πâ‡∏ö‡∏£‡∏£‡πÑ‡∏î / ‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ö‡∏£‡∏£‡πÑ‡∏î‡∏´‡∏ô‡∏µ‡πÑ‡∏ü / ‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏ü‡∏ï‡πå ..."
                    v-model="editingTagName" />
                </div>
                <div>
                  <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                  <textarea type="text" rows="3"
                    class="border rounded-md w-full py-2 px-2 mt-1 border-stone-300 hover:border-amber-600 bg-amber-100"
                    placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." v-model="editingTagDescription" />
                </div>
                <div>
                  <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡πÄ‡∏ó‡πá‡∏Å‡∏™‡∏µ</label>
                  <div class="p-8 flex flex-col justify-center items-center">
                    <label class="text-gray-700 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
                    <ColorPicker v-model="editingTagColor" />
                    <p class="text-sm text-gray-500 mt-2">‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {{ editingTagColor }}</p>
                  </div>
                </div>

                <div class="mt-4 flex justify-center space-x-2">
                  <button
                    class="bg-blue-500 text-white rounded-lg px-4 py-2 hover:bg-blue-600 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                    @click="updateTag" :disabled="loading">
                    {{ loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...' : '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡πÄ‡∏ó‡πá‡∏Å' }}
                  </button>
                  <button class="bg-red-500 text-white rounded-lg px-4 py-2 hover:bg-red-600 transition shadow-md"
                    @click="cancelEdit">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
          <div class="mt-6">
            <label class="text-lg font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
            <div class="mt-2 p-4 border rounded-lg bg-gray-50">
              <div class="flex flex-wrap gap-2">
                <div v-for="(tag, index) in tags" :key="index"
                  class="px-1 py-1 rounded-lg text-white font-medium text-sm flex items-center space-x-2" :style="{
                    backgroundColor: tag.color,
                    border: `2px solid ${tag.color}`,
                    color: getContrastColor(tag.color)
                  }">
                  <span class="px-2">{{ tag.name }}</span>
                  <button @click="startEditTag(tag)" class="rounded-full shadow-md p-1 bg-gray-300 hover:bg-gray-50">
                    <img src="/imgHotel/edit.png" alt="edit" class="w-3 h-3">
                  </button>
                  <button @click="removeTag(tag._id)"
                    class="ml-1 text-xs font-bold hover:bg-black hover:bg-opacity-20 rounded-full w-5 h-5 flex items-center justify-center bg-stone-700">
                    x
                  </button>
                </div>
              </div>
              <div v-if="tags.length === 0" class="text-gray-500 text-sm italic">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 flex justify-center space-x-2">

          <button @click="goToMainManagePOS"
            class="bg-red-600 rounded-lg px-4 py-2 text-white hover:bg-red-700 transition">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
      </div>
    </template>
  </TemplatePartner>
</template>

<script setup>
import TemplatePartner from "@/components/TemplatePartner.vue";
import { ref, onMounted } from 'vue';
import ColorPicker from '@/components/element/ColorPicker.vue';
import { useRouter } from 'vue-router';
import Swal from 'sweetalert2';


// Reactive data
const selectedColor = ref('#FFBB00'); // ‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
const tagName = ref(''); // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏Å
const tagDescription = ref(''); // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ó‡πá‡∏Å
const tags = ref([]); // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const loading = ref(false); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
const router = useRouter();

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const isEditing = ref(false); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const editingTagId = ref(null); // ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const editingTagName = ref(''); // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const editingTagDescription = ref(''); // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
const editingTagColor = ref(''); // ‡∏™‡∏µ‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
function getContrastColor(hexColor) {
  // ‡πÅ‡∏õ‡∏•‡∏á hex ‡πÄ‡∏õ‡πá‡∏ô RGB
  const r = parseInt(hexColor.slice(1, 3), 16);
  const g = parseInt(hexColor.slice(3, 5), 16);
  const b = parseInt(hexColor.slice(5, 7), 16);

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;

  // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡πà‡∏≤‡∏á
  return brightness > 128 ? '#000000' : '#ffffff';
}

function goToMainManagePOS() {
  router.push('/mainmanagepos');
}



// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà
async function createTag(tagData) {
  try {
    console.log('üöÄ Sending request to: http://localhost:9999/HotelSleepGun/pos/tags');
    console.log('üì¶ Request data:', tagData);

    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
    }

    const response = await fetch('http://localhost:9999/HotelSleepGun/pos/tags', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(tagData)
    });

    console.log('üì° Response status:', response.status);

    const result = await response.json();
    console.log('‚úÖ Response data:', result);

    if (!response.ok) {
      throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ó‡πá‡∏Å');
    }

    return result;
  } catch (error) {
    console.error('‚ùå Error creating tag:', error);
    throw error;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function getAllTags() {
  try {
    console.log('üîÑ Fetching tags from: http://localhost:9999/HotelSleepGun/pos/tags');

    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
    }

    const response = await fetch('http://localhost:9999/HotelSleepGun/pos/tags', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    console.log('üì° Response status:', response.status);

    const result = await response.json();
    console.log('‚úÖ Response data:', result);

    if (!response.ok) {
      throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πá‡∏Å');
    }

    return result.data;
  } catch (error) {
    console.error('‚ùå Error fetching tags:', error);
    throw error;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ï‡∏≤‡∏° ID
async function deleteTagById(tagId) {
  try {
    console.log('üóëÔ∏è Deleting tag with ID:', tagId);

    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
    }

    const response = await fetch(`http://localhost:9999/HotelSleepGun/pos/tags/${tagId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    console.log('üì° Response status:', response.status);

    const result = await response.json();
    console.log('‚úÖ Response data:', result);

    if (!response.ok) {
      throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å');
    }

    return result;
  } catch (error) {
    console.error('‚ùå Error deleting tag:', error);
    throw error;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ó‡πá‡∏Å
async function updateTagById(tagId, tagData) {
  try {
    console.log('üîÑ Updating tag with ID:', tagId);
    console.log('üì¶ Update data:', tagData);

    const token = localStorage.getItem('token');
    if (!token) {
      throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö token ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
    }

    const response = await fetch(`http://localhost:9999/HotelSleepGun/pos/tags/${tagId}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(tagData)
    });

    console.log('üì° Response status:', response.status);

    const result = await response.json();
    console.log('‚úÖ Response data:', result);

    if (!response.ok) {
      throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ó‡πá‡∏Å');
    }

    return result;
  } catch (error) {
    console.error('‚ùå Error updating tag:', error);
    throw error;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å
async function addTag() {
  if (tagName.value.trim() === '') {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏Å');
    return;
  }

  loading.value = true;

  try {
    console.log('üéØ Starting to add tag...');

    const tagData = {
      name: tagName.value.trim(),
      description: tagDescription.value.trim(),
      color: selectedColor.value
    };

    console.log('üìù Tag data to send:', tagData);

    const result = await createTag(tagData);

    console.log('‚úÖ Tag created successfully:', result);

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    tags.value.push(result.data);

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
    tagName.value = '';
    tagDescription.value = '';
    selectedColor.value = '#FFBB00';

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    await Swal.fire({
      icon: 'success',
      title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ó‡πá‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      showConfirmButton: false,
      timer: 1200
    });
  } catch (error) {
    console.error('‚ùå Error in addTag:', error);

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`
    });
  } finally {
    loading.value = false;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ó‡πá‡∏Å
function startEditTag(tag) {
  console.log('‚úèÔ∏è Starting to edit tag:', tag);

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  editingTagId.value = tag._id;
  editingTagName.value = tag.name;
  editingTagDescription.value = tag.description || '';
  editingTagColor.value = tag.color;

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  isEditing.value = true;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
function cancelEdit() {
  console.log('‚ùå Canceling edit mode');

  // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  editingTagId.value = null;
  editingTagName.value = '';
  editingTagDescription.value = '';
  editingTagColor.value = '';

  // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  isEditing.value = false;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ó‡πá‡∏Å
async function updateTag() {
  if (editingTagName.value.trim() === '') {
    await Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏Å'
    });
    return;
  }

  loading.value = true;

  try {
    console.log('üîÑ Starting to update tag...');

    const tagData = {
      name: editingTagName.value.trim(),
      description: editingTagDescription.value.trim(),
      color: editingTagColor.value
    };

    console.log('üìù Tag data to update:', tagData);

    const result = await updateTagById(editingTagId.value, tagData);

    console.log('‚úÖ Tag updated successfully:', result);

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    const index = tags.value.findIndex(tag => tag._id === editingTagId.value);
    if (index > -1) {
      tags.value[index] = {
        ...tags.value[index],
        name: tagData.name,
        description: tagData.description,
        color: tagData.color
      };
    }

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    cancelEdit();

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    await Swal.fire({
      icon: 'success',
      title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ó‡πá‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      showConfirmButton: false,
      timer: 1200
    });
  } catch (error) {
    console.error('‚ùå Error in updateTag:', error);

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ó‡πá‡∏Å: ${error.message}`
    });
  } finally {
    loading.value = false;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å
async function removeTag(tagId) {
  try {
    console.log('üóëÔ∏è Removing tag with ID:', tagId);
    console.log('üîç Tag ID type:', typeof tagId);
    console.log('üîç Tag ID value:', tagId);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ tagId ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!tagId) {
      console.error('‚ùå Tag ID is undefined or null');
      await Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö'
      });
      return;
    }

    // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢ SweetAlert
    const result = await Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å?',
      text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '‡∏•‡∏ö',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6'
    });

    if (!result.isConfirmed) {
      return;
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å
    await deleteTagById(tagId);

    // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    const index = tags.value.findIndex(tag => tag._id === tagId || tag.id === tagId);
    if (index > -1) {
      tags.value.splice(index, 1);
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    await Swal.fire({
      icon: 'success',
      title: '‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      showConfirmButton: false,
      timer: 1200
    });
  } catch (error) {
    console.error('‚ùå Error in removeTag:', error);

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    await Swal.fire({
      icon: 'error',
      title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
      text: `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ó‡πá‡∏Å: ${error.message}`
    });
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function saveData() {
  console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', {
    tags: tags.value
  });

  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ component ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
onMounted(async () => {
  try {
    console.log('üîÑ Loading tags on mount...');
    const fetchedTags = await getAllTags();
    console.log('üì¶ Fetched tags:', fetchedTags);

    // Debug: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á tag object
    if (fetchedTags && fetchedTags.length > 0) {
      console.log('üîç First tag structure:', fetchedTags[0]);
      console.log('üîç First tag keys:', Object.keys(fetchedTags[0]));
      console.log('üîç First tag _id:', fetchedTags[0]._id);
      console.log('üîç First tag id:', fetchedTags[0].id);
    }

    tags.value = fetchedTags;
  } catch (error) {
    console.error('‚ùå Error loading tags:', error);

    // Check if it's an authentication error
    if (error.message.includes('token') || error.message.includes('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö')) {
      alert('‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà');
      // Redirect to login page
      router.push('/loginpartner');
    } else {
      alert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${error.message}`);
    }
  }
});
</script>
