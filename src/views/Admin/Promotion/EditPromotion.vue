<template>
  <TemplateAdmin>
    <template #header>
      <label>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô</label>
    </template>
    <template #content>
      <div class="p-4 max-w-[3000px] mx-auto">


        <div class="md:rounded-b-lg px-4 pt-4 max-w-7xl mx-auto">
          <p class="text-2xl font-bold text-center py-4">
            ‡πÄ‡πÄ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô
          </p>

          <div class="flex flex-col xl:flex-row justify-center lg:space-x-5 item-center">

            <div class="w-full lg:w-4/6">
              <div>
                <p class="mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p>
                <input class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4"
                  v-model="promotion.name" />
              </div>
              <div>
                <p class="mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                <textarea rows="5" v-model="promotion.detail"
                  class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4"
                  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô&#10;‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏• 50GB&#10;‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà Cloud 1TB..."></textarea>
              </div>

              <div>
                <p class="mb-2">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p>
                <input type="date" v-model="promotion.dateStart" :min="new Date().toISOString().split('T')[0]"
                  class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4" />
              </div>
              <div>
                <div>
                  <p>‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ?</p>
                  <div class="flex items-center gap-4 mb-4">
                    <label class="flex items-center">
                      <input type="radio" value="yes" v-model="hasEndDate" class="mr-2" />
                      ‡∏°‡∏µ
                    </label>
                    <label class="flex items-center">
                      <input type="radio" value="no" v-model="hasEndDate" class="mr-2" />
                      ‡πÑ‡∏°‡πà‡∏°‡∏µ
                    </label>
                  </div>
                </div>

                <!-- ‡πÅ‡∏™‡∏î‡∏á input ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏°‡∏µ" -->
                <div v-if="hasEndDate === 'yes'">
                  <p class="mb-2">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p>
                  <input type="date" v-model="promotion.dateFinish" :min="promotion.dateStart"
                    class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4" />
                </div>
              </div>

              <div>
                <p class="mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ï‡πá‡∏°</p>
                <input type="number" v-model="promotion.price"
                  class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4" />
              </div>

              <div>
                <p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ?</p>
                <div class="flex items-center gap-4 mb-4">
                  <label class="flex items-center">
                    <input type="radio" value="yesReduced" v-model="promotion.wantToReduce" class="mr-2" />
                    ‡πÉ‡∏ä‡πà
                  </label>
                  <label class="flex items-center">
                    <input type="radio" value="noReduced" v-model="promotion.wantToReduce" class="mr-2" />
                    ‡πÑ‡∏°‡πà
                  </label>
                </div>
              </div>

              <div v-if="promotion.wantToReduce === 'yesReduced'">
                <div>
                  <p>‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤</p>
                  <div class="flex items-center gap-4 mb-4">
                    <label class="flex items-center">
                      <input type="radio" value="reduced" v-model="promotion.discountType" class="mr-2" />
                      ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏≤‡∏ó
                    </label>
                    <label class="flex items-center">
                      <input type="radio" value="percent" v-model="promotion.discountType" class="mr-2" />
                      ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô %
                    </label>
                  </div>

                  <div v-if="promotion.discountType === 'reduced'">
                    <p class="mb-2">‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤</p>
                    <input type="number" v-model="promotion.reducedPrice" :max="promotion.price || null" :min="0"
                      @input="handleReducedInput"
                      class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4" />
                  </div>

                  <div v-if="promotion.discountType === 'percent'">
                    <p class="mb-2">‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô %</p>
                    <input type="number" v-model="promotion.percentPrice" :max="100" :min="0"
                      @input="handlePercentInput"
                      class="border border-gray-300 px-3 py-2 rounded w-full resize-none mb-4" />
                  </div>
                </div>
              </div>
            </div>


            <div class="lg:w-3/6">
              <div class="md:max-w-md mx-auto rounded-lg mt-3 shadow-lg border-2">
                <!-- ‡∏´‡∏±‡∏ß‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô -->
                <div class="py-4 text-center font-bold text-lg break-all whitespace-pre-wrap text-black">
                  {{ promotion.name || '‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô' }}
                </div>

                <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô -->
                <div>
                  <div class="bg-white px-6 pb-6 space-y-2 text-gray-700">
                    <!-- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                    <div v-if="promotion.wantToReduce === 'yesReduced' && (
                      (promotion.discountType === 'reduced' && promotion.price && promotion.reducedPrice) ||
                      (promotion.discountType === 'percent' && promotion.price && promotion.percentPrice)
                    )" class="text-center mt-2">
                      <div class="flex flex-col justify-center items-center">
                        <span class="text-xl text-gray-400 line-through mr-2">
                          {{ promotion.price }}
                        </span>
                        <span class="text-6xl font-bold text-red-600 align-middle">
                          <!-- ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏≤‡∏ó -->
                          <template v-if="promotion.discountType === 'reduced'">
                            {{ Number(promotion.price) - Number(promotion.reducedPrice) }}
                          </template>
                          <!-- ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô % -->
                          <template v-else-if="promotion.discountType === 'percent'">
                            {{ (Number(promotion.price) - (Number(promotion.price) * Number(promotion.percentPrice) /
                              100)).toFixed(2) }}
                          </template>
                        </span>
                      </div>
                      <div>
                        <span class="text-sm font-thin text-gray-400">‡∏ö‡∏≤‡∏ó / ‡∏Ñ‡∏ô / ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
                      </div>
                    </div>
                    <!-- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ -->
                    <div v-else class="text-6xl font-bold text-center text-gray-900">
                      {{ promotion.price || '0' }} <br>
                      <span class="text-sm font-thin text-gray-400">‡∏ö‡∏≤‡∏ó / ‡∏Ñ‡∏ô / ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
                    </div>
                    <ul class="list-none mt-4">
                      <li v-for="(line, index) in promotion.detail.split('\n')" :key="index" class="flex items-start">
                        <span class="mr-2">‚úî</span>
                        <span class="break-all whitespace-pre-wrap w-0 flex-1 text-gray-700">{{ line }}</span>
                      </li>
                      <li class="flex items-center mt-5">
                        <span class="mr-2 mt-1">üìÖ</span>
                        <span class="text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°: {{ promotion.dateStart || '-' }}</span>
                      </li>
                      <li v-if="hasEndDate === 'yes'" class="flex items-center">
                        <span class="mr-2 mt-1">üìÖ</span>
                        <span class="text-sm">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î: {{ promotion.dateFinish || '-' }}</span>
                      </li>
                      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤ -->

                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="my-6 flex justify-center space-x-3">
            <button @click="navigateBackToMainPromotion"
              class="bg-red-500 py-2 px-3 text-white rounded-lg hover:bg-red-600">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button class="bg-gray-400 py-2 px-3 text-white rounded-lg hover:bg-gray-600">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ó</button>
            <button @click="updatePromotion"
              class="bg-green-500 py-2 px-3 text-white rounded-lg hover:bg-green-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </div>
      </div>
    </template>
  </TemplateAdmin>
</template>

<script setup>
import TemplateAdmin from "@/components/TemplateAdmin.vue";
import { ref, onMounted, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'



const hasEndDate = ref(null)
const router = useRouter()
const route = useRoute()

const promotion = ref({
  name: '',
  detail: '',
  dateStart: '',
  dateFinish: '',
  price: '',
  wantToReduce: '',
  reducedPrice: '',
  dateReducedPercentPriceStart: '',
  dateReducedPercentPriceFinish: '',
  percentPrice: '',
  discountType: '',
})

const loading = ref(true)
const error = ref('')

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏î‡∏¥‡∏°
onMounted(async () => {
  try {
    const id = route.params.id
    const token = localStorage.getItem('token')
    const res = await fetch(`http://localhost:9999/HotelSleepGun/promotion/get/${id}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    if (!res.ok) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô')
    const data = await res.json()
    promotion.value = data
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input type="date"
    if (promotion.value.dateStart) {
      promotion.value.dateStart = promotion.value.dateStart.slice(0, 10)
    }
    if (promotion.value.dateFinish) {
      promotion.value.dateFinish = promotion.value.dateFinish.slice(0, 10)
    }
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ hasEndDate ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    hasEndDate.value = data.dateFinish ? 'yes' : 'no'
    loading.value = false
  } catch (e) {
    error.value = e.message
    loading.value = false
  }
})

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
async function updatePromotion() {
  try {
    const id = route.params.id
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡πÉ‡∏´‡πâ‡∏•‡∏ö dateFinish ‡∏≠‡∏≠‡∏Å
    if (hasEndDate.value !== 'yes') {
      promotion.value.dateFinish = ''
    }
    const token = localStorage.getItem('token')
    const res = await fetch(`http://localhost:9999/HotelSleepGun/promotion/update/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify(promotion.value)
    })
    if (!res.ok) throw new Error('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
    router.push('/mainmanagepromotion')
  } catch (e) {
    alert(e.message)
  }
}


function navigateBackToMainPromotion() {
  router.push('/mainpromotion')
}

</script>